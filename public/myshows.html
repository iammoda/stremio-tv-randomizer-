<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TV Show Randomizer - Settings</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1 class="title">TV Show Randomizer</h1>
        <button
          class="theme-toggle"
          onclick="toggleTheme()"
          title="Toggle dark/light mode"
        >
          <svg
            class="theme-icon"
            viewBox="0 0 24 24"
            width="20"
            height="20"
            fill="currentColor"
          >
            <!-- Moon icon (shown in dark mode) -->
            <path
              class="icon-moon"
              d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
            />
            <!-- Sun icon (shown in light mode) -->
            <g class="icon-sun" style="display: none">
              <circle cx="12" cy="12" r="5" />
              <line
                x1="12"
                y1="1"
                x2="12"
                y2="3"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="12"
                y1="21"
                x2="12"
                y2="23"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="4.22"
                y1="4.22"
                x2="5.64"
                y2="5.64"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="18.36"
                y1="18.36"
                x2="19.78"
                y2="19.78"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="1"
                y1="12"
                x2="3"
                y2="12"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="21"
                y1="12"
                x2="23"
                y2="12"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="4.22"
                y1="19.78"
                x2="5.64"
                y2="18.36"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <line
                x1="18.36"
                y1="5.64"
                x2="19.78"
                y2="4.22"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </g>
          </svg>
        </button>
      </header>

      <section id="installOnly" class="install-only" style="display: none">
        <h2 class="section-title">Install & Configure</h2>
        <div class="install-content">
          <div class="install-step">
            <span class="install-number">1</span>
            <p>
              Open the install page:<br />
              <code id="installPageUrl">https://YOUR-VERCEL-URL</code>
            </p>
          </div>
          <div class="install-step">
            <span class="install-number">2</span>
            <p>Copy the generated install URL and add it in Stremio</p>
          </div>
          <div class="install-step">
            <span class="install-number">3</span>
            <p>
              Click <strong>Configure</strong> in Stremio to open this page with
              your key
            </p>
          </div>
          <div class="install-step">
            <span class="install-number">4</span>
            <p>Search and add shows once your key is present</p>
          </div>
        </div>
      </section>

      <section class="add-section requires-key">
        <h2 class="section-title">Add Show</h2>
        <div class="search-container">
          <div class="search-box">
            <div class="search-input-wrapper">
              <input
                type="text"
                id="searchInput"
                placeholder="Search for a TV show..."
                oninput="handleSearch(this.value)"
                onfocus="showSearchResults()"
              />
              <button
                type="button"
                class="clear-btn"
                id="searchClear"
                aria-label="Clear search"
                onclick="clearSearchInput()"
              >
                <span aria-hidden="true">x</span>
              </button>
            </div>
            <button class="search-btn" onclick="searchShows()">Search</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>
        <p class="hint">Search for TV shows and click + to add</p>
      </section>

      <section class="shows-section requires-key">
        <div class="section-header">
          <h2 class="section-title">My Shows</h2>
          <span class="show-count" id="showCount"
            >0 / <span id="showLimit">150</span></span
          >
        </div>

        <div class="my-shows-search">
          <input
            type="text"
            id="myShowsSearch"
            placeholder="Search in my shows..."
            oninput="filterMyShows(this.value)"
          />
          <button
            type="button"
            class="clear-btn"
            id="myShowsClear"
            aria-label="Clear my shows search"
            onclick="clearMyShowsSearch()"
          >
            <span aria-hidden="true">x</span>
          </button>
        </div>

        <div id="showsList" class="shows-grid"></div>

        <div id="paginationControls" class="pagination-controls">
          <button
            id="showMoreBtn"
            class="btn btn-pagination"
            onclick="showMore()"
          >
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M12 16l-6-6h12z" />
              </svg>
            </span>
            Show More
          </button>
          <button
            id="showAllBtn"
            class="btn btn-pagination"
            onclick="showAll()"
          >
            Show All
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M10 6l6 6-6 6" />
              </svg>
            </span>
          </button>
        </div>

        <div id="emptyState" class="empty-state">
          <p>No shows added yet</p>
          <p class="empty-hint">Search above to add your favorite TV shows</p>
        </div>

        <div id="noSearchResults" class="empty-state" style="display: none">
          <p>No matching shows</p>
        </div>
      </section>

      <section class="actions-section requires-key">
        <button class="btn btn-danger" onclick="clearAll()">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
          </span>
          Clear All Shows
        </button>
      </section>

      <section class="help-section requires-key">
        <h2 class="section-title">How to Use</h2>
        <div class="help-content">
          <div class="help-item">
            <span class="help-number">1</span>
            <p>Search for TV shows and select from results</p>
          </div>
          <div class="help-item">
            <span class="help-number">2</span>
            <p>Click the gear icon on a show to configure season filters</p>
          </div>
          <div class="help-item">
            <span class="help-number">3</span>
            <p>
              In Stremio, find <strong>"Find Random Episode"</strong> in your
              catalog
            </p>
          </div>
          <div class="help-item">
            <span class="help-number">4</span>
            <p>
              Click "Random All Shows" or a specific show to play a random
              episode
            </p>
          </div>
        </div>
      </section>

      <footer class="footer">
        <p>TV Show Randomizer for Stremio</p>
      </footer>
    </div>

    <!-- Season Settings Modal -->
    <div id="seasonModal" class="modal" onclick="closeSeasonModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3 id="seasonModalTitle">Season Settings</h3>
          <button class="modal-close" onclick="closeSeasonModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p class="modal-hint">
            Select which seasons to include in random selection. If none are
            selected, all seasons will be used.
          </p>
          <div id="seasonCheckboxes" class="season-checkboxes"></div>
          <div id="seasonLoading" class="loading">Loading seasons...</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSeasonModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveSeasonSettings()">
            Save
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = '/api';
      let searchTimeout = null;
      let isDarkMode = true;
      let allShows = [];
      let displayedShows = [];
      let currentLimit = 4;
      const SHOWS_PER_PAGE = 4;
      let userKey = '';
      let currentSeasonShow = null;
      let availableSeasons = [];
      let selectedSeasons = [];

      function initTheme() {
        const savedTheme = localStorage.getItem('tvRandomizerTheme');
        if (savedTheme !== null) {
          isDarkMode = savedTheme === 'dark';
        }
        applyTheme();
      }

      function toggleTheme() {
        isDarkMode = !isDarkMode;
        localStorage.setItem(
          'tvRandomizerTheme',
          isDarkMode ? 'dark' : 'light',
        );
        applyTheme();
      }

      function applyTheme() {
        document.body.classList.toggle('light-mode', !isDarkMode);
        const moonIcon = document.querySelector('.icon-moon');
        const sunIcon = document.querySelector('.icon-sun');
        if (isDarkMode) {
          moonIcon.style.display = 'block';
          sunIcon.style.display = 'none';
        } else {
          moonIcon.style.display = 'none';
          sunIcon.style.display = 'block';
        }
      }

      async function loadShows() {
        if (!userKey) {
          allShows = [];
          updatePagination();
          return;
        }
        try {
          const response = await fetch(apiUrl('/shows'));
          const data = await response.json();
          allShows = data.shows || [];
          document.getElementById('showLimit').textContent = data.limit || 150;
          currentLimit = 4;
          filterMyShows(document.getElementById('myShowsSearch').value);
        } catch (e) {
          console.error('Failed to load shows:', e);
        }
      }

      async function searchShows() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML =
          '<div class="search-loading">Searching...</div>';
        resultsContainer.style.display = 'block';

        try {
          const response = await fetch(
            apiUrl(`/search?q=${encodeURIComponent(query)}`),
          );
          const data = await response.json();

          if (data.metas && data.metas.length > 0) {
            renderSearchResults(data.metas);
          } else {
            resultsContainer.innerHTML =
              '<div class="search-no-results">No shows found</div>';
          }
        } catch (e) {
          console.error('Search error:', e);
          resultsContainer.innerHTML =
            '<div class="search-no-results">Search failed. Try again.</div>';
        }
      }

      function handleSearch(value) {
        clearTimeout(searchTimeout);
        toggleClearButton('searchInput', 'searchClear');
        if (value.length < 2) {
          document.getElementById('searchResults').style.display = 'none';
          return;
        }
        searchTimeout = setTimeout(() => {
          searchShows();
        }, 300);
      }

      function renderSearchResults(metas) {
        const container = document.getElementById('searchResults');
        container.innerHTML = metas
          .map(
            (show) => `
                <div class="search-result" onclick="selectShow('${show.id}', &quot;${escapeJs(show.name)}&quot;, '${show.poster || ''}')">
                    <img src="${show.poster}" alt="${show.name}" class="result-poster" onerror="this.style.display='none'">
                    <div class="result-info">
                        <span class="result-name">${show.name}</span>
                        ${show.year ? `<span class="result-year">${show.year}</span>` : ''}
                    </div>
                    <span class="result-add">+</span>
                </div>
            `,
          )
          .join('');
      }

      function escapeJs(text) {
        if (!text) return '';
        return text
          .replace(/\\/g, '\\\\')
          .replace(/'/g, "\\'")
          .replace(/"/g, '\\"')
          .replace(/\n/g, '\\n')
          .replace(/\r/g, '\\r')
          .replace(/\t/g, '\\t');
      }

      async function selectShow(id, name, poster) {
        try {
          const response = await fetch(apiUrl('/shows'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imdbId: id }),
          });
          const result = await response.json();

          if (result.success) {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            loadShows();
            showToast(`Added "${name}" to your list`);
          } else if (result.exists) {
            showToast('Show already in your list');
          } else if (result.error) {
            showToast(result.error);
          } else {
            showToast('Failed to add show');
          }
        } catch (e) {
          alert('Error adding show');
        }
      }

      async function removeShow(imdbId) {
        try {
          await fetch(apiUrl(`/shows/${imdbId}`), { method: 'DELETE' });
          loadShows();
        } catch (e) {
          alert('Error removing show');
        }
      }

      async function clearAll() {
        if (
          confirm('Are you sure you want to remove all shows from your list?')
        ) {
          try {
            const payload = await fetch(apiUrl('/shows')).then((r) => r.json());
            for (const show of payload.shows || []) {
              await removeShow(show.id);
            }
            loadShows();
          } catch (e) {
            alert('Error clearing shows');
          }
        }
      }

      function filterMyShows(query) {
        toggleClearButton('myShowsSearch', 'myShowsClear');
        query = query.toLowerCase().trim();

        if (query === '') {
          displayedShows = [...allShows];
        } else {
          displayedShows = allShows.filter((show) =>
            show.name.toLowerCase().includes(query),
          );
        }

        currentLimit = 4;
        updatePagination();
      }

      function showMore() {
        currentLimit += SHOWS_PER_PAGE;
        updatePagination();
      }

      function showAll() {
        currentLimit = displayedShows.length;
        updatePagination();
      }

      function updatePagination() {
        const container = document.getElementById('showsList');
        const emptyState = document.getElementById('emptyState');
        const noSearchResults = document.getElementById('noSearchResults');
        const paginationControls =
          document.getElementById('paginationControls');
        const showMoreBtn = document.getElementById('showMoreBtn');
        const showAllBtn = document.getElementById('showAllBtn');
        const countEl = document.getElementById('showCount');
        const limitEl = document.getElementById('showLimit');

        countEl.innerHTML = `${allShows.length} / <span id="showLimit">${limitEl.textContent}</span>`;

        if (allShows.length === 0) {
          container.innerHTML = '';
          emptyState.style.display = 'block';
          noSearchResults.style.display = 'none';
          paginationControls.style.display = 'none';
          return;
        }

        emptyState.style.display = 'none';

        if (displayedShows.length === 0) {
          container.innerHTML = '';
          noSearchResults.style.display = 'block';
          paginationControls.style.display = 'none';
          return;
        }

        noSearchResults.style.display = 'none';

        const showsToShow = displayedShows.slice(0, currentLimit);
        container.innerHTML = showsToShow
          .map(
            (show) => `
                <div class="show-card">
                    <div class="show-image-wrapper">
                        <img src="${show.poster}" alt="${show.name}" class="show-poster" onerror="this.src='https://via.placeholder.com/100x150?text=?'">
                        <div class="show-actions">
                          <button class="btn-settings" onclick="openSeasonSettings('${show.id}', '${escapeJs(show.name)}')" title="Season settings">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                              <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                            </svg>
                          </button>
                          <button class="btn-remove" onclick="removeShow('${show.id}')" title="Remove show">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                          </button>
                        </div>
                    </div>
                    <div class="show-info">
                        <h3 class="show-name">${show.name}</h3>
                    </div>
                </div>
            `,
          )
          .join('');

        const hasMore = currentLimit < displayedShows.length;
        const showAllVisible =
          displayedShows.length > SHOWS_PER_PAGE && displayedShows.length > 4;

        if (hasMore || showAllVisible) {
          paginationControls.style.display = 'flex';
          showMoreBtn.style.display = hasMore ? 'inline-flex' : 'none';
          showAllBtn.style.display =
            showAllVisible && currentLimit < displayedShows.length
              ? 'inline-flex'
              : 'none';
        } else {
          paginationControls.style.display = 'none';
        }
      }

      // Season Settings Modal
      async function openSeasonSettings(showId, showName) {
        currentSeasonShow = showId;
        document.getElementById('seasonModalTitle').textContent =
          `${showName} - Season Settings`;
        document.getElementById('seasonModal').classList.add('active');
        document.getElementById('seasonCheckboxes').innerHTML = '';
        document.getElementById('seasonLoading').style.display = 'block';

        try {
          // Fetch available seasons and current settings in parallel
          const [seasonsRes, settingsRes] = await Promise.all([
            fetch(apiUrl(`/shows/${showId}/seasons`)),
            fetch(apiUrl(`/shows/${showId}/settings`)),
          ]);

          const seasonsData = await seasonsRes.json();
          const settingsData = await settingsRes.json();

          availableSeasons = seasonsData.seasons || [];
          const episodeCounts = seasonsData.episodeCounts || {};
          selectedSeasons = settingsData.enabledSeasons || [];

          document.getElementById('seasonLoading').style.display = 'none';

          if (availableSeasons.length === 0) {
            document.getElementById('seasonCheckboxes').innerHTML =
              '<p class="no-seasons">No seasons found for this show.</p>';
            return;
          }

          document.getElementById('seasonCheckboxes').innerHTML =
            availableSeasons
              .map((season) => {
                const isChecked =
                  selectedSeasons.length === 0 ||
                  selectedSeasons.includes(season);
                const epCount = episodeCounts[season] || 0;
                return `
              <label class="season-checkbox">
                <input type="checkbox" value="${season}" ${isChecked ? 'checked' : ''} onchange="updateSeasonSelection()">
                <span class="season-label">Season ${season}</span>
                <span class="episode-count">${epCount} episode${epCount !== 1 ? 's' : ''}</span>
              </label>
            `;
              })
              .join('');
        } catch (e) {
          console.error('Failed to load season settings:', e);
          document.getElementById('seasonLoading').style.display = 'none';
          document.getElementById('seasonCheckboxes').innerHTML =
            '<p class="error">Failed to load seasons. Please try again.</p>';
        }
      }

      function updateSeasonSelection() {
        const checkboxes = document.querySelectorAll(
          '#seasonCheckboxes input[type="checkbox"]',
        );
        selectedSeasons = Array.from(checkboxes)
          .filter((cb) => cb.checked)
          .map((cb) => parseInt(cb.value, 10));
      }

      async function saveSeasonSettings() {
        if (!currentSeasonShow) return;

        // If all seasons are selected, save as empty array (means "all")
        const seasonsToSave =
          selectedSeasons.length === availableSeasons.length
            ? []
            : selectedSeasons;

        try {
          const response = await fetch(
            apiUrl(`/shows/${currentSeasonShow}/settings`),
            {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabledSeasons: seasonsToSave }),
            },
          );

          if (response.ok) {
            showToast('Season settings saved');
            closeSeasonModal();
          } else {
            showToast('Failed to save settings');
          }
        } catch (e) {
          console.error('Failed to save season settings:', e);
          showToast('Failed to save settings');
        }
      }

      function closeSeasonModal(event) {
        if (event && event.target !== document.getElementById('seasonModal'))
          return;
        document.getElementById('seasonModal').classList.remove('active');
        currentSeasonShow = null;
      }

      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }

      function showSearchResults() {
        const query = document.getElementById('searchInput').value.trim();
        if (
          query &&
          document.getElementById('searchResults').children.length > 0
        ) {
          document.getElementById('searchResults').style.display = 'block';
        }
      }

      function toggleClearButton(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        if (!input || !button) return;
        button.style.display = input.value ? 'inline-flex' : 'none';
      }

      function clearSearchInput() {
        const input = document.getElementById('searchInput');
        if (!input) return;
        input.value = '';
        document.getElementById('searchResults').style.display = 'none';
        toggleClearButton('searchInput', 'searchClear');
        input.focus();
      }

      function clearMyShowsSearch() {
        const input = document.getElementById('myShowsSearch');
        if (!input) return;
        input.value = '';
        filterMyShows('');
        toggleClearButton('myShowsSearch', 'myShowsClear');
        input.focus();
      }

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
          document.getElementById('searchResults').style.display = 'none';
        }
      });

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeSeasonModal();
        }
      });

      function initUserKey() {
        const urlKey = new URLSearchParams(window.location.search).get('user');
        userKey = urlKey ? urlKey.trim() : '';
        setKeyMode(Boolean(userKey));
        const installPage = document.getElementById('installPageUrl');
        if (installPage) {
          installPage.textContent = `${window.location.origin}`;
        }
      }

      function setKeyMode(enabled) {
        const installOnly = document.getElementById('installOnly');
        const keySections = document.querySelectorAll('.requires-key');
        installOnly.style.display = enabled ? 'none' : 'block';
        keySections.forEach((section) => {
          section.style.display = enabled ? 'block' : 'none';
        });
      }

      function apiUrl(path) {
        const separator = path.includes('?') ? '&' : '?';
        return `${API_BASE}${path}${separator}user=${encodeURIComponent(userKey)}`;
      }

      initTheme();
      initUserKey();
      loadShows();
      toggleClearButton('searchInput', 'searchClear');
      toggleClearButton('myShowsSearch', 'myShowsClear');
    </script>
  </body>
</html>
